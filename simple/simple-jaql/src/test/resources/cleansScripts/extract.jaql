using cleansing;

extract from $scrubbed_earmarks into {
	$funds = group by $.earmarkId {
		id: generateId('earmark'),
		amount: sum($[*].amount),
		currency: 'USD',
		date: {
			year: $[0].enactedYear
		},
		subject: $[0].shortDescription
	}
	$recipients = group by $.recipient {
		id: generateId('earmark_person'),
		names: [$.recipient],
		receivedFunds: transform $ into { 
			id: $funds[$.earmarkId].id,
			amount: $.amount
		},
		category: $[0].recipientType
	}
};

write $funds to hdfs('Earmark_Funds.json');
